<!DOCTYPE html><!--
Copyright 2021 James Deery
Released under the MIT licence, https://opensource.org/licenses/MIT
--><html lang="en"><head><title>M8 Display</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="theme-color" content="#000"><link rel="shortcut icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAABlBMVEUAAAAA7/9Rg7lhAAAAHklEQVQI12NgQAJKNgxmLgxaLgxKNQxKLmBUwYAKAFHoA0vrVbyeAAAAAElFTkSuQmCC"><link rel="apple-touch-icon" href="icon.png"><link rel="manifest" href="app.webmanifest"><style>
@font-face{font-family:"m8stealth57";src:url("data:font/woff2;base64,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") format("woff2")}@font-face{font-family:"m8stealth89";src:url("data:font/woff2;base64,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") format("woff2")}body{font-family:sans-serif;background-color:#000;color:#eee;margin:0px;font-size:16px}a,a:visited{color:#00efff;text-decoration:none}a:hover,a:visited:hover{text-decoration:underline}a:focus,a:visited:focus{outline:1px solid #00efff}kbd{font-family:sans-serif;background-color:#444;color:#00efff;font-size:16px;margin:0 2px;padding:2px 5px;border-radius:3px}.hidden{display:none}.build{color:#888}label,input,select,button{appearance:none;font-family:"m8stealth57";font-size:14px;background-color:#000;color:#fff}label:hover,input:hover,select:hover,button:hover{background-color:#00efff;color:#000}label:active,input:active,select:active,button:active{background-color:#00bfcc;color:#fff}label:focus,label:focus-within,input:focus,input:focus-within,select:focus,select:focus-within,button:focus,button:focus-within{outline:none;color:#00efff}label:focus:hover,label:focus-within:hover,input:focus:hover,input:focus-within:hover,select:focus:hover,select:focus-within:hover,button:focus:hover,button:focus-within:hover{color:#000}label:focus:active,label:focus-within:active,input:focus:active,input:focus-within:active,select:focus:active,select:focus-within:active,button:focus:active,button:focus-within:active{color:#fff}button{border:3px solid #fff;padding:20px}input[type=checkbox]{font-family:"m8stealth57"}input[type=checkbox]::after{content:"OFF"}input[type=checkbox]:checked::after{content:"ON"}input[type=file]{border:3px solid #fff;padding:20px}select{padding:5px 32px 5px 5px;background-color:rgba(0,0,0,0);background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23fff' stroke-width='3' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 10px center;background-size:16px;font-family:sans-serif;font-size:12px}progress{border:3px solid #fff;height:40px;width:100%}progress::-webkit-progress-bar{background-color:#000}progress::-webkit-progress-value{background-color:#00efff}#display{position:relative;width:100vw;height:75vw;max-width:133.3333333333vh;max-height:100vh;margin:0 auto;top:0;bottom:0;left:0;right:0;user-select:none}#display canvas,#display svg{position:absolute;image-rendering:pixelated;width:100%;height:100%}#display svg text{font-family:"m8stealth57";font-size:16px}#display svg.big text{font-family:"m8stealth89";font-size:24px}#display #buttons{position:absolute;top:25px;width:100%;text-align:center}body.mapping #display #buttons{display:none}#display #mapping-buttons{display:none;position:absolute;top:25px;width:100%;text-align:center}body.mapping #display #mapping-buttons{display:block}#display #mapping-buttons button{margin:0 5px 10px}#display.with-controls,body.mapping #display{height:150vw;max-width:66.6666666667vh}#display.with-controls canvas,#display.with-controls svg,body.mapping #display canvas,body.mapping #display svg{height:50%}#display.with-controls #controls,body.mapping #display #controls{display:block}#display #controls{display:none;position:relative;width:100%;height:50%;top:50%}#display #controls>div{position:absolute;width:20.3125%;height:27.0833%;border:3px solid #aaa;border-radius:10px;background-color:#333;box-sizing:border-box;padding:5px;text-align:center;font-size:80%;transition-property:border-color,background-color;transition-duration:200ms}#display #controls>div.active{border-color:#0cf;background-color:#0cf;transition-duration:0s}#display #controls>div.active[data-action=edit]{border-color:#d48;background-color:#d48}#display #controls>div.active[data-action=option]{border-color:#66c;background-color:#66c}#display #controls>div.active[data-action=select]{border-color:#d73;background-color:#d73}#display #controls>div.active[data-action=start]{border-color:#5a3;background-color:#5a3}#display #controls>div.mapping{border-color:#e30;z-index:1001}#display #mapping-help{display:none;position:absolute;bottom:50%;width:100%;font-family:"m8stealth57";text-align:center}body.mapping #display #mapping-help{display:block}body.mapping #display #mapping-help .select-action{display:block}body.mapping #display #mapping-help .enter-input{display:none}body.mapping.capturing #display #mapping-help .select-action{display:none}body.mapping.capturing #display #mapping-help .enter-input{display:block;position:relative;z-index:1001}#capture-shield{display:none;position:fixed;top:0;bottom:0;left:0;right:0;background-color:rgba(0,0,0,.75);z-index:1000}body.mapping.capturing #capture-shield{display:block}#settings{position:fixed;top:0;bottom:0;left:0;right:0;background-color:rgba(0,0,0,.5);transition:background-color 80ms linear 0s;user-select:none}#settings.hidden{display:block;width:0;height:0;background-color:rgba(0,0,0,0)}#settings.hidden .setting{visibility:hidden;margin-left:-323px;transition:none}#settings.hidden #menu-button{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23fff' stroke-width='1.5' d='M2 4h12M2 8h12M2 12h12'/%3e%3c/svg%3e")}#settings.hidden.auto-hide #menu-button{opacity:0%;transition:opacity .8s linear .8s}#settings.hidden.auto-hide #menu-button:hover,#settings.hidden.auto-hide #menu-button:focus{opacity:100%;transition:opacity 0s}#settings #menu-button{width:32px;height:32px;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23fff' stroke-width='1.5' d='M3 3l10 10M3 13l10-10'/%3e%3c/svg%3e");background-repeat:no-repeat;background-color:rgba(0,0,0,0);border-color:rgba(0,0,0,0);font-size:0;margin-bottom:-3px}#settings #menu-button:hover{background-color:#00efff}#settings #menu-button:active{background-color:#00bfcc;color:#fff}#settings #menu-button:focus{color:#00efff;border-color:#00efff}#settings #menu-button:focus:hover{color:#000}#settings #menu-button:focus:active{color:#fff}#settings .setting{width:320px;border:3px solid #fff;border-width:3px 3px 0 0;margin-left:0;transition:margin-left 80ms linear 0s}#settings .setting:last-child{border-bottom-width:3px}#settings .setting label{display:block;position:relative;padding:10px}#settings .setting label input,#settings .setting label select{position:absolute;top:0;bottom:0;right:0;margin:0;border:0}#settings .setting label input[type=checkbox]{padding:10px}#settings .setting label select{width:50%}#settings .setting button{display:block;width:100%;margin:0;border:0;padding:10px}#firmware{position:fixed;top:0;bottom:0;left:0;right:0;padding:100px;background-color:rgba(0,0,0,.75);text-align:center;font-family:"m8stealth57";line-height:1.5}#firmware.hidden{display:none}#firmware p.select-file-msg,#firmware input[type=file],#firmware p.file-loading-msg,#firmware p.file-error-msg,#firmware p.select-device-msg,#firmware button.select-device,#firmware p.device-error-msg,#firmware p.flash-msg,#firmware button.flash,#firmware p.flashing-msg,#firmware progress.flash,#firmware p.flash-error-msg,#firmware p.flash-success-msg{display:none;margin:20px auto}#firmware p.file-error-msg,#firmware p.device-error-msg,#firmware p.flash-error-msg{color:#e22}#firmware.file-select p.select-file-msg,#firmware.file-select input[type=file]{display:block}#firmware.file-loading p.file-loading-msg{display:block}#firmware.file-loading button.close{display:none}#firmware.file-error p.select-file-msg,#firmware.file-error input[type=file],#firmware.file-error p.file-error-msg{display:block}#firmware.file-loaded p.select-device-msg,#firmware.file-loaded button.select-device{display:block}#firmware.device-error p.select-device-msg,#firmware.device-error button.select-device,#firmware.device-error p.device-error-msg{display:block}#firmware.device-selected p.flash-msg,#firmware.device-selected button.flash{display:block}#firmware.flashing p.flashing-msg,#firmware.flashing progress.flash{display:block}#firmware.flashing button.close{display:none}#firmware.flash-error p.select-device-msg,#firmware.flash-error button.select-device,#firmware.flash-error p.flash-error-msg{display:block}#firmware.flash-success p.flash-success-msg{display:block}#firmware button.close{display:block;position:absolute;right:100px;bottom:100px}#info{position:absolute;top:100px;left:100px;right:100px;padding:20px;background-color:rgba(0,0,0,.75);text-align:center;line-height:1.5}#info h1{font-family:"m8stealth57";font-size:32px;margin:0 0 16px}.error{position:absolute;top:100px;left:100px;right:100px;border:3px solid #fff;padding:20px;background-color:#a22;user-select:text}.error p{margin-top:0}.error p:last-child{margin-bottom:0}#reload{position:fixed;bottom:0;left:0;right:0;text-align:center}#reload button{border-bottom-width:0}

</style></head><body><div id="display"><canvas id="canvas" width="320" height="240"></canvas><div id="buttons" class="hidden"><button id="connect">Connect</button></div><div id="mapping-buttons"></div><div id="mapping-help"><p class="select-action">Click a key to add a new mapping</p><p class="enter-input">Press a keyboard key or gamepad button</p></div><div id="controls"><div data-action="edit" style="top: 2.0833%; left: 76.5625%"></div><div data-action="option" style="top: 2.0833%; left: 53.125%"></div><div data-action="up" style="top: 6.25%; left: 25%"></div><div data-action="left" style="top: 37.5%; left: 1.5625%"></div><div data-action="down" style="top: 37.5%; left: 25%"></div><div data-action="right" style="top: 37.5%; left: 48.4375%"></div><div data-action="select" style="top: 70.8333%; left: 27.3438%"></div><div data-action="start" style="top: 70.8333%; left: 50.7813%"></div></div></div><div id="serial-fail" class="error hidden"><p>Failed to connect over Serial.
Are you sure your Teensy is connected and the M8 Headless firmware is loaded?</p><p>Make sure that there are no other programs running which may have the serial port open.</p><p>On Linux you may also need make sure you have permission to open the serial port (eg. make yourself a member of the <code>dialout</code> group).</p><p>It is also possible there's a bug in this code.
There may be some messages in the developer console that will help with debugging.</p></div><div id="usb-fail" class="error hidden"><p>Failed to connect with WebUSB.
Are you sure your Teensy is connected and the M8 Headless firmware is loaded?</p><p>Connecting with WebUSB is known not to work on Windows, Linux and some Samsung phones.
Please make sure you are using an up to date version of Chrome or Edge (89+).</p></div><div id="no-serial-usb" class="error hidden"><p>Your browser doesn't appear to have Serial or WebUSB support.
These are only currently supported in Chrome and some Chrome-derived browsers.</p></div><div id="info"><h1>M8 Display</h1><p>This is a display for the <a href="https://github.com/DirtyWave/M8HeadlessFirmware" target="_blank" rel="noopener">M8 Headless firmware</a> running on a Teensy 4.1, or a <a href="https://dirtywave.com/" target="_blank" rel="noopener">real M8 device</a>.
You can use keyboard and gamepad input or use on-screen controls.
Where possible, the audio output from the M8 is routed to your default audio output device.
Firmware can be installed and updated from the menu.</p><p>By default the arrow keys on your keyboard map to the arrow keys on the M8.
Shift is <kbd>Left Shift</kbd>, Play is <kbd>Space</kbd>, Option is <kbd>Z</kbd>, and Edit is <kbd>X</kbd>.
These control mappings and other settings can be configured from the menu.</p><p>A virtual keyboard from <kbd>A</kbd> to <kbd>'</kbd> lets you send MIDI notes.
Use <kbd>-</kbd>/<kbd>=</kbd> to change octaves and <kbd>[</kbd>/<kbd>]</kbd> to change velocity.</p><p>Now that this page has loaded it will work completely offline.
All settings are stored locally by your browser.</p><p>Source code and more details are available at <a href="https://github.com/derkyjadex/M8WebDisplay" target="_blank" rel="noopener">github.com/<wbr>derkyjadex/<wbr>M8WebDisplay</a>.</p><button>OK</button><p class="build">Build 2024-04-24T22:53:40 5ca0b61X</p></div><div id="settings" class="hidden"><button id="menu-button">Menu</button></div><div id="reload" class="hidden"><button>An update is available. Click to reload.</button></div><div id="capture-shield"></div><div id="firmware" class="hidden"><p class="select-file-msg">Select a firmware file</p><input type="file" accept=".hex"><p class="file-loading-msg">Loading file...</p><p class="file-error-msg">The selected file does not appear to be a valid Teensy 4.1 firmware file</p><p class="select-device-msg">Connect your Teensy board and press the little button on the board</p><button class="select-device">Select Teensy Device</button><p class="device-error-msg">The selected device does not appear to be a Teensy 4.1</p><p class="flash-msg">Ready to flash</p><button class="flash">Flash</button><p class="flashing-msg">Flashing...</p><progress class="flash"></progress><p class="flash-error-msg">There was an error flashing the device. You can try again.</p><p class="flash-success-msg">Flashing completed successfully</p><button class="close">Close</button></div><script>
function e(e){document.querySelectorAll(e).forEach((e=>e.classList.remove("hidden")))}function t(e){document.querySelectorAll(e).forEach((e=>e.classList.add("hidden")))}function n(e){return new Promise((t=>setTimeout(t,e)))}function r(e,t,n){const r=document.createElement("button");return r.innerText=t,o(r,"click",n),"string"==typeof e&&(e=document.querySelector(e)),e.append(r),r}function o(e,t,n,r){"string"==typeof e?e=document.querySelectorAll(e):e instanceof Array||(e=[e]);for(const o of e)o.addEventListener(t,n,r)}function a(e,t,n,r){e.removeEventListener(t,n,r)}class i{_device;_parser;_onConnectionChanged;_waitingForUserSelection;constructor(e,t){this._parser=e,this._onConnectionChanged=t,this._waitingForUserSelection=!1,o(navigator.usb,"connect",(e=>{this._waitingForUserSelection||this.connect(!0).catch((()=>{}))}))}get isConnected(){return!!this._device}async _startReading(){try{for(;this._device;){const e=await this._device.transferIn(3,512);"ok"!==e.status?this.disconnect():this._parser.process(new Uint8Array(e.data.buffer))}}catch(e){console.error(e),this.disconnect()}}async _send(e){if(this._device)try{await this._device.transferOut(3,new Uint8Array(e))}catch(e){console.error(e),this.disconnect()}}async sendKeys(e){this._send([67,e])}async sendNoteOn(e,t){this._send([75,e,t])}async sendNoteOff(){this._send([75,255])}async _reset(){await this._device.transferOut(3,new Uint8Array([68])),await n(50),this._parser.reset(),await this._device.transferOut(3,new Uint8Array([69,82]))}async disconnect(){const e=this._device;e&&(this._device=null,await e.transferOut(3,new Uint8Array([68])).catch((()=>{})),await e.close().catch((()=>{})),this._onConnectionChanged(!1))}async connect(e=!1){if(!this._device)try{const t=(await navigator.usb.getDevices()).filter((e=>5824===e.vendorId&&1162===e.productId));if(this._device=1===t.length?t[0]:null,this._device||(e?this._onConnectionChanged(!1):this._device=await this._requestDevice()),!this._device)return;await this._device.open(),await this._device.selectConfiguration(1),await this._device.claimInterface(1),await this._device.controlTransferOut({requestType:"class",recipient:"interface",request:34,value:3,index:1}),await this._device.controlTransferOut({requestType:"class",recipient:"interface",request:32,value:0,index:1},new Uint8Array([128,37,0,0,0,0,8])),await this._reset(),this._startReading(),this._onConnectionChanged(!0)}catch(e){throw console.error(e),this.disconnect(e),e}}async _requestDevice(){this._waitingForUserSelection=!0;try{return await navigator.usb.requestDevice({filters:[{vendorId:5824,productId:1162}]})}catch(e){if(e.code!==DOMException.NOT_FOUND_ERR)throw e;return null}finally{this._waitingForUserSelection=!1}}}class s{_port;_parser;_onConnectionChanged;_waitingForUserSelection;constructor(e,t){this._parser=e,this._onConnectionChanged=t,this._waitingForUserSelection=!1,o(navigator.serial,"connect",(e=>{this._waitingForUserSelection||this.connect(!0).catch((()=>{}))}))}get isConnected(){return!!this._port}async _startReading(){try{for(;this._port;){const{value:e,done:t}=await this._port.reader.read();if(e)try{this._parser.process(e)}catch(e){console.error(e)}if(t)return}}catch(e){console.error(e),this.disconnect()}}async _send(e){if(this._port&&this._port.writer)try{await this._port.writer.write(new Uint8Array(e))}catch(e){console.error(e),this.disconnect()}}async sendKeys(e){this._send([67,e])}async sendNoteOn(e,t){this._send([75,e,t])}async sendNoteOff(){this._send([75,255])}async _reset(){await this._port.writer.write(new Uint8Array([68])),await n(50),this._parser.reset(),await this._port.writer.write(new Uint8Array([69,82]))}async disconnect(){const e=this._port;e&&(this._port=null,e.writer&&await e.writer.write(new Uint8Array([68])).catch((()=>{})),e.reader&&await e.reader.cancel().catch((()=>{})),await e.close().catch((()=>{})),this._onConnectionChanged(!1))}async connect(e=!1){if(!this._port)try{const t=(await navigator.serial.getPorts()).filter((e=>{const t=e.getInfo();return 5824===t.usbVendorId&&1162===t.usbProductId}));if(this._port=1===t.length?t[0]:null,this._port||(e?this._onConnectionChanged(!1):this._port=await this._requestPort()),!this._port)return;await this._port.open({baudRate:9600,dataBits:8,stopBits:1,parity:"none",bufferSize:4096}),this._port.reader=await this._port.readable.getReader(),this._port.writer=await this._port.writable.getWriter(),await this._reset(),this._startReading(),this._onConnectionChanged(!0)}catch(e){throw console.error(e),this.disconnect(e),e}}async _requestPort(){this._waitingForUserSelection=!0;try{return await navigator.serial.requestPort({filters:[{usbVendorId:5824,usbProductId:1162}]})}catch(e){if(e.code!==DOMException.NOT_FOUND_ERR)throw e;return null}finally{this._waitingForUserSelection=!1}}}const c=Symbol("normal"),l=Symbol("escape"),d=Symbol("error"),u=new Uint8Array(0);var h=Object.freeze({__proto__:null,blit_vert:"#version 300 es\nout vec2 srcCoord;const vec2 corners[]=vec2[](vec2(0,0),vec2(0,1),vec2(1,0),vec2(1,1));void main(){vec2 pos =corners[gl_VertexID]*vec2(2.0,2.0)+vec2(-1.0,-1.0);gl_Position =vec4(pos,0.0,1.0);srcCoord =corners[gl_VertexID]*vec2(320.0,240.0);}",rect_vert:"#version 300 es\nlayout(location =0)in vec4 shape;layout(location =1)in vec3 colour;out vec3 colourV;const vec2 corners[]=vec2[](vec2(0,0),vec2(0,1),vec2(1,0),vec2(1,1));const vec2 camScale =vec2(2.0 /320.0,-2.0 /240.0);const vec2 camOffset =vec2(-160.0,-120.0);void main(){vec2 pos =shape.xy;vec2 size =shape.zw;pos =((corners[gl_VertexID]*size +pos)+camOffset)*camScale;gl_Position =vec4(pos,0.0,1.0);colourV =colour;}",text1_vert:"#version 300 es\nlayout(location =0)in vec3 colour;layout(location =1)in float char;out vec3 colourV;out vec2 fontCoord;const vec2 corners[]=vec2[](vec2(0,0),vec2(0,1),vec2(1,0),vec2(1,1));const vec2 camScale =vec2(2.0 /320.0,-2.0 /240.0);const vec2 camOffset =vec2(-160.0,-120.0);const vec2 size =vec2(5.0,7.0);void main(){float row;float col =modf(float(gl_InstanceID)/40.0,row)*40.0;vec2 pos =vec2(col,row)*vec2(8.0,10.0)+vec2(0.0,3.0);pos =((corners[gl_VertexID]*size +pos)+camOffset)*camScale;gl_Position =vec4(char ==0.0 ? vec2(2.0): pos,0.0,1.0);colourV =colour;fontCoord =(vec2(char -1.0,0.0)+corners[gl_VertexID])*size;}",text2_vert:"#version 300 es\nlayout(location =0)in vec3 colour;layout(location =1)in float char;out vec3 colourV;out vec2 fontCoord;const vec2 corners[]=vec2[](vec2(0,0),vec2(0,1),vec2(1,0),vec2(1,1));const vec2 camScale =vec2(2.0 /320.0,-2.0 /240.0);const vec2 camOffset =vec2(-160.0,-120.0);const vec2 size =vec2(8.0,9.0);void main(){float row;float col =modf(float(gl_InstanceID)/40.0,row)*40.0;row =row -3.0;vec2 pos =vec2(col,row)*vec2(10.0,12.0)+vec2(0.0,0.0);if(row ==0.0){pos =pos +vec2(0.0,5.0);}pos =((corners[gl_VertexID]*size +pos)+camOffset)*camScale;gl_Position =vec4(char ==0.0 ? vec2(2.0): pos,0.0,1.0);colourV =colour;fontCoord =(vec2(char -1.0,0.0)+corners[gl_VertexID])*size;}",wave_vert:"#version 300 es\nlayout(location =0)in uint value;const vec2 camScale =vec2(2.0 /320.0,-2.0 /240.0);const vec2 camOffset =vec2(-160.0,-120.0);void main(){vec2 pos =vec2(float(gl_VertexID),float(value));pos =(pos +vec2(0.5)+camOffset)*camScale;gl_PointSize =1.0;gl_Position =vec4(pos,0.0,1.0);}",blit_frag:"#version 300 es\nprecision highp float;uniform sampler2D src;in vec2 srcCoord;out vec4 fragColour;void main(){fragColour =texelFetch(src,ivec2(srcCoord),0);}",rect_frag:"#version 300 es\nprecision highp float;in vec3 colourV;out vec4 fragColour;void main(){fragColour =vec4(colourV,1.0);}",text1_frag:"#version 300 es\nprecision highp float;uniform sampler2D font;in vec2 fontCoord;in vec3 colourV;out vec4 fragColour;void main(){vec4 fontTexel =texelFetch(font,ivec2(fontCoord),0);fragColour =vec4(colourV,fontTexel.r);}",text2_frag:"#version 300 es\nprecision highp float;uniform sampler2D font;in vec2 fontCoord;in vec3 colourV;out vec4 fragColour;void main(){vec4 fontTexel =texelFetch(font,ivec2(fontCoord),0);fragColour =vec4(colourV,fontTexel.r);}",wave_frag:"#version 300 es\nprecision highp float;uniform vec3 colour;out vec4 fragColour;void main(){fragColour =vec4(colour,1.0);}"});const f=1024;function _(e,t,n){const r=e.createShader(n);if(e.shaderSource(r,h[t]),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))throw new Error(`Failed to compile shader (${t}): ${e.getShaderInfoLog(r)}`);return r}function g(e,t){return function(e,t,n,r){const o=e.createProgram();if(e.attachShader(o,n),e.attachShader(o,r),e.linkProgram(o),!e.getProgramParameter(o,e.LINK_STATUS))throw new Error(`Failed to link program (${t}): ${e.getProgramInfoLog(o)}`);return o}(e,t,_(e,`${t}_vert`,e.VERTEX_SHADER),_(e,`${t}_frag`,e.FRAGMENT_SHADER))}let v=!1;function m(){v||(window.location.reload(),v=!0)}let w=()=>{};o("#reload button","click",(()=>w())),o("#menu-button","click",(()=>{return e="#settings",void document.querySelectorAll(e).forEach((e=>e.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden")));var e})),o("#settings","click",(e=>{"settings"===e.target.id&&t("#settings")}));const p={},A={};function b(e,t,n){const r=E(e,n),a=document.createElement("div");a.classList.add("setting");const i=document.createElement("label");i.innerText=t,a.append(i);const s=document.createElement("input");s.setAttribute("type","checkbox"),s.checked=r,i.append(s),o(s,"change",(()=>x(e,s.checked))),document.getElementById("settings").append(a)}function y(e,n){const o=document.createElement("div");o.classList.add("setting"),r(o,n,(()=>{t("#settings"),p[e]&&p[e]()})),document.getElementById("settings").append(o)}function E(e,t){let n=localStorage[e];return n=void 0===n?t:JSON.parse(n),A[e]=n,n}function x(e,t){A[e]=t,p[e]&&p[e](t),localStorage[e]=JSON.stringify(t)}function T(e,t){p[e]=t,void 0!==R(e)&&t(R(e))}function R(e){return A[e]}b("showControls","Show Controls",!1),b("hideMenu","Hide Menu",!1),b("enableAudio","Enable Audio",!0),function(e,t,n,r){const a=E(e,r),i=document.createElement("div");i.classList.add("setting");const s=document.createElement("label");s.innerText=t,i.append(s);const c=document.createElement("select");for(const[e,t]of Object.entries(n)){const n=document.createElement("option");n.value=e,n.text=t,c.append(n)}c.value=a,s.append(c),o(c,"change",(()=>x(e,c.value))),document.getElementById("settings").append(i)}("displayType","Display Type",{webgl2:"WebGL2",old:"Canvas + SVG"},"webgl2"),b("snapPixels","Snap Pixels",!0),b("virtualKeyboard","Virtual Keyboard",!0),b("midiForwarding","Midi Forwarding",!1),b("preventSleep","Prevent Sleep",!1),y("controlMapping","Control Mapping"),y("firmware","Load Firmware"),y("fullscreen","Fullscreen"),y("about","About"),T("hideMenu",(e=>document.getElementById("settings").classList.toggle("auto-hide",e)));const S=Object.freeze({KeyA:0,KeyW:1,KeyS:2,KeyE:3,KeyD:4,KeyF:5,KeyT:6,KeyG:7,KeyY:8,KeyH:9,KeyU:10,KeyJ:11,KeyK:12,KeyO:13,KeyL:14,KeyP:15,Semicolon:16,Quote:17,BracketLeft:"velDown",BracketRight:"velUp",Minus:"octDown",Equal:"octUp"});let I,C,D=!0,U=3,B=103,F=null;let N=0;const M={up:6,down:5,left:7,right:2,select:4,start:3,option:1,edit:0},G=Object.freeze({ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",ShiftLeft:"select",Space:"start",KeyZ:"option",KeyX:"edit",Gamepad12:"up",Gamepad64:"up",Gamepad13:"down",Gamepad65:"down",Gamepad14:"left",Gamepad66:"left",Gamepad15:"right",Gamepad67:"right",Gamepad8:"select",Gamepad2:"select",Gamepad5:"select",Gamepad9:"start",Gamepad3:"start",Gamepad1:"option",Gamepad0:"edit"}),O={};function L(e,t,n){if(e)return H?(n&&n.preventDefault(),void(t&&H(e))):void(function(e,t,n){if(!D||!n||n.ctrlKey||n.metaKey||n.altKey)return!1;const r=S[e];if(void 0===r)return!1;if(n.repeat)return!0;switch(r){case"octDown":t&&(U=Math.max(U-1,0));break;case"octUp":t&&(U=Math.min(U+1,10));break;case"velDown":t&&(B=Math.max(B-8,7));break;case"velUp":t&&(B=Math.min(B+8,127));break;default:const e=r+12*U;if(e>128)return!1;t?(F=r,I.sendNoteOn(e,B)):r===F&&I.sendNoteOff()}return!0}(e,t,n)||k(O[e],t,n))}function P(e,t){const n=t.target.dataset.action;n&&(Z&&e&&!H?async function(e,t){const n=e=>{e.stopPropagation(),K()};o(document.body,"mousedown",n,!0),o(document.body,"touchstart",n,!0),document.body.classList.add("capturing"),e.classList.add("mapping");try{const e=await(K(),new Promise((e=>{H=e})).then((e=>(H=null,e))));e&&(O[e]=t,x("inputMap",O))}finally{e.classList.remove("mapping"),document.body.classList.remove("capturing"),a(document.body,"touchstart",n,!0),a(document.body,"mousedown",n,!0)}}(t.target,n):k(n,e,t))}function k(e,t,n){if(!e)return;n&&n.preventDefault();const r=M[e];if(void 0===r)return;const o=t?N|1<<r:N&~(1<<r);o!==N&&(N=o,C.sendKeys(N),document.querySelector(`#controls > [data-action="${e}"]`).classList.toggle("active",t))}function V(e){C=e,function(e){I=e,T("virtualKeyboard",(e=>{D=e,I.sendNoteOff()}))}(C),o(document,"keydown",(e=>L(e.code,!0,e))),o(document,"keyup",(e=>L(e.code,!1,e)));const t=document.getElementById("controls");o(t,"mousedown",(e=>P(!0,e))),o(t,"touchstart",(e=>P(!0,e))),o(t,"mouseup",(e=>P(!1,e))),o(t,"touchend",(e=>P(!1,e))),r("#mapping-buttons","Reset to Default",Q),r("#mapping-buttons","Clear All",J),r("#mapping-buttons","Done",$),Object.assign(O,E("inputMap",G))}let Y=!1;const j=[],z={0:[!0,!1,!1,!1],1:[!0,!1,!1,!0],2:[!1,!1,!1,!0],3:[!1,!0,!1,!0],4:[!1,!0,!1,!1],5:[!1,!0,!0,!1],6:[!1,!1,!0,!1],7:[!0,!1,!0,!1],8:[!1,!1,!1,!1],15:[!1,!1,!1,!1]};function W(){if(!Y)return;let e=!1;for(const t of navigator.getGamepads()){if(!t||!t.connected)continue;e=!0;let n=j[t.index];if(n||(n=j[t.index]={buttons:[],axes:Array(t.axes.length).fill(null).map((e=>({})))}),"standard"!==t.mapping)for(let e=0;e<t.axes.length;e++){if(!1===n.axes[e].isHat)continue;const r=3.5*(t.axes[e]+1),o=Math.abs(Math.round(r)-r),a=z[Math.round(r)];if(o>48e-8||void 0===a)n.axes[e].isHat=!1;else if(0!==r||!0===n.axes[e].isHat){n.axes[e].isHat=!0;for(let e=0;e<4;e++){const t=a[e];n.buttons[64+e]!==t&&(n.buttons[64+e]=t,L(`Gamepad${64+e}`,t))}}}for(let e=0;e<t.axes.length;e++){const r=t.axes[e];if(!0===n.axes[e].isHat||Math.abs(r)>1)continue;const o=r<=-.5,a=r>=.5;n.axes[e].negative!==o&&(n.axes[e].negative=o,L(`GamepadAxis${e}-`,o)),n.axes[e].positive!==a&&(n.axes[e].positive=a,L(`GamepadAxis${e}+`,a))}for(let e=0;e<t.buttons.length;e++){const r=t.buttons[e].pressed;n.buttons[e]!==r&&(n.buttons[e]=r,L(`Gamepad${e}`,r))}}e?requestAnimationFrame(W):Y=!1}o(window,"gamepadconnected",(e=>{"standard"!==e.gamepad.mapping&&console.warn("Non-standard gamepad attached. Mappings may be funny."),Y||(Y=!0,W())})),o(window,"gamepaddisconnected",(e=>{j[e.gamepad.index]=null}));let X,Z=!1,q=null,H=null;function $(){K(),document.body.classList.remove("mapping"),Z=!1,q&&q()}function K(){H&&H(null)}function Q(){for(const e of Object.keys(O))delete O[e];Object.assign(O,G),x("inputMap",O)}function J(){for(const e of Object.keys(O))delete O[e];x("inputMap",O)}let ee=!0;async function te(e=1){if(!X&&ee){try{let t;for(X=new AudioContext,await navigator.mediaDevices.getUserMedia({audio:!0});t=await ne(),!t&&--e>0;)await n(300);if(!t)throw new Error("M8 not found");const r=await navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:t},autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1}});X.createMediaStreamSource(r).connect(X.destination),"running"!==X.state&&function(){const e=["keydown","mousedown","touchstart"];function t(){X&&X.resume(),e.forEach((e=>a(document,e,t)))}e.forEach((e=>o(document,e,t)))}()}catch(e){console.error(e),re()}ee||re()}}async function ne(){return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audioinput"===e.kind&&/M8/.test(e.label)&&"default"!==e.deviceId&&"communications"!==e.deviceId)).map((e=>e.deviceId))[0]}async function re(){X&&await X.close().catch((()=>{})),X=null}const oe=Symbol("START_LINE"),ae=Symbol("HEX1"),ie=Symbol("HEX2");async function se(e,t,n){const r=[];for await(let{address:o,data:a}of async function*(e){const t=new Uint8Array(260);let n=oe,r=1,o=0,a=0,i=0,s=0,c=1,l=!1,d=0;const u=e.stream().getReader();for(;;){const e=await u.read();if(!e.value)break;for(const u of e.value){if(o++,l)throw new le(`Unexpected data after end record, line ${r} char ${o}`);switch(n){case oe:if(58!==u)throw new le(`Expecting ':' at start of line ${r} char ${o}`);n=ae;break;case ae:if(13===u)continue;if(10===u){if(a<c)throw new le(`Unexpected end of line on line ${r} char ${o}`);if(0!==s)throw new le(`Invalid checksum on line ${r}`);switch(t[3]){case 0:yield{address:d+256*t[1]+t[2],data:t.subarray(4,c-1)};break;case 1:l=!0;break;case 2:d=256*t[4]+t[5]<<4;break;case 3:case 5:break;case 4:d=256*t[4]+t[5]<<16;break;default:throw new le(`Invalid record type on line ${r}`)}n=oe,r++,o=0,a=0,s=0,c=1}else{if(a>=c)throw new le(`Record too long on line ${r} char ${o}`);const e=ce(u);if(null===e)throw new le(`Expecting hex character on line ${r} char ${o}`);i=16*e,n=ie}break;case ie:const e=ce(u);if(null===e)throw new le(`Expecting hex character on line ${r} char ${o}`);i+=e,s=s+i&255,0===a&&(c=i+5),t[a++]=i,n=ae}}if(e.done)break}if(l)return;if(n!=ae||byte<c)throw new le(`Unexpected end of file, line ${r} char ${o}`);if(0!==s)throw new le(`Invalid checksum on line ${r}`);if(1!==t[3])throw new le(`Missing end of file record, line ${r}`)}(e)){if(o-=n,o<0)throw new le("Negative address after applying offset");let e=Math.floor(o/t),i=0;for(;i<a.length;){let n=r[e];n||(n=r[e]=new Uint8Array(t),n.fill(255));const s=e*t,c=s+t,l=o+i-s,d=o+a.length>c?t:l+a.length-i;for(let e=l;e<d;e++)n[e]=a[i++];e++}}return r}function ce(e){return e>=48&&e<=57?e-48:e>=65&&e<=70?e-55:e>=97&&e<=102?e-87:null}class le extends Error{constructor(...e){super(...e),this.name="HexFormatError"}}function de(e){document.getElementById("firmware").className=e}let ue=null,he=null;o("#firmware button.close","click",(()=>{ue=null,he=null,document.querySelector("#firmware input").value=null,de("hidden")})),o("#firmware input","change",(async e=>{ue=null;const t=e.target.files[0];if(t){de("file-loading");try{ue=await se(t,1024,1610612736)}catch(e){return console.error(e),void de("file-error")}de("file-loaded")}})),o("#firmware button.select-device","click",(async()=>{he=null;const e=await navigator.hid.requestDevice({filters:[{vendorId:5824,productId:1144}]});he=e&&e[0],he&&(!function(e){const t=e.collections[0];return t&&65436===t.usagePage&&37===t.usage}(he)?(he=null,de("device-error")):de("device-selected"))})),o("#firmware button.flash","click",(async()=>{const e=document.querySelector("#firmware progress.flash");de("flashing");try{await async function(e,t,r){r(0),await t.open();try{const o=new Uint8Array(1088);for(let a=0;a<e.length;a++){if(0!==a&&(!e[a]||e[a].every((e=>255===e))))continue;const i=1024*a;o[0]=255&i,o[1]=i>>8&255,o[2]=i>>16&255,o.set(e[a],64),await t.sendReport(0,o),r((a+1)/e.length),await n(0===a?1500:5)}o.fill(0),o[0]=255,o[1]=255,o[2]=255,await t.sendReport(0,o)}finally{await t.close().catch((()=>{}))}}(ue,he,(t=>e.value=t))}catch(e){return console.error(e),void de("flash-error")}de("flash-success")}));let fe=!1,_e=null;function ge(e){fe=e,ve()}async function ve(){if(!navigator.wakeLock)return;const e=fe&&R("preventSleep")&&"visible"===document.visibilityState,t=_e&&!_e.released;if(!e&&t)_e.release(),_e=null;else if(e&&!t)try{_e=await navigator.wakeLock.request("screen"),o(_e,"release",(()=>ve()))}catch{_e=null}}T("preventSleep",(()=>ve())),o(document,"visibilitychange",(()=>ve()));const me="M8 MIDI 1",we="Launchpad X LPX MIDI In";function pe(e){const t=e[0];var n,r;240!==t&&(144===t&&(n=e[1],r=e[2],Ie(we,0!==r?[144,n,36]:[144,n,0]),Ie(me,[144,n,r])))}function Ae(){!function(e){const t=[240,0,32,41,2,12].concat(e);t.push(247),Ie(we,t)}([0,127])}let be,ye=[],Ee=!1;const xe=["Midi Through Port-0","Launchpad X LPX DAW In"],Te="Launchpad X LPX MIDI In";function Re(e){ye.includes(e)||(console.log(`CONNECTED: ${e.name}`),ye.push(e),e.onmidimessage=t=>{!function(e,t){Ee&&(t.name===Te?pe(e.data):function(e,t){be.outputs.forEach((n=>{n.name!==t.name&&(xe.includes(n.name)||n.send(e.data))}))}(e,t))}(t,e)},e.name===Te&&Ae())}function Se(e){"output"!==e.type&&("connected"===e.state?Re(e):function(e){console.log(`DISCONNECTED: ${e.name}`),ye=ye.filter((t=>t!==e))}(e))}function Ie(e,t){be.outputs.forEach((n=>{e&&n.name!==e||(console.log(`SENDING TO ${n.name}`),console.log(t),n.send(t))}))}function Ce(e,t,n){const r=`rgb(${e}, ${t}, ${n})`;document.body.style.backgroundColor=r,document.documentElement.style.backgroundColor=r,x("background",[e,t,n])}const De=E("background",[0,0,0]);Ce(De[0],De[1],De[2]);const Ue="webgl2"===R("displayType")?new class{_canvas;_gl;_bg=[0,0,0];_frameQueued=!1;_onBackgroundChanged;_fontConfig=[[8,10,0,0],[10,12,0,-40]];_fontId=0;constructor(e,t){this._bg=[e[0]/255,e[1]/255,e[2]/255],this._onBackgroundChanged=t,this._canvas=document.getElementById("canvas"),this._gl=this._canvas.getContext("webgl2",{alpha:!1,antialias:!1});const n=this._gl;this._setupRects(n),this._setupText(n),this._setupWave(n),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.viewport(0,0,320,240),this._queueFrame()}setFont(e){if(this._fontId==e)return;this._fontId=e;const t=this._gl;this._setupText(t)}_rectShader;_rectVao;_rectShapes=new Uint16Array(6144);_rectColours=new Uint8Array(this._rectShapes.buffer,8);_rectCount=0;_rectsClear=!0;_rectsTex;_rectsFramebuffer;_blitShader;_setupRects(e){this._rectShader=g(e,"rect"),this._rectVao=e.createVertexArray(),e.bindVertexArray(this._rectVao),this._rectShapes.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._rectShapes.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._rectShapes,e.STREAM_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,4,e.UNSIGNED_SHORT,!1,12,0),e.vertexAttribDivisor(0,1),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,3,e.UNSIGNED_BYTE,!0,12,8),e.vertexAttribDivisor(1,1),this._rectsTex=e.createTexture(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._rectsTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,320,240,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),this._rectsFramebuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this._rectsTex,0),this._blitShader=g(e,"blit"),e.useProgram(this._blitShader),e.uniform1i(e.getUniformLocation(this._blitShader,"src"),0)}_renderRects(e){this._rectsClear&&(e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.clearColor(this._bg[0],this._bg[1],this._bg[2],1),e.clear(e.COLOR_BUFFER_BIT),this._rectsClear=!1),this._rectCount>0&&(e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.useProgram(this._rectShader),e.bindVertexArray(this._rectVao),e.bindBuffer(e.ARRAY_BUFFER,this._rectShapes.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._rectShapes.subarray(0,6*this._rectCount)),e.drawArraysInstanced(e.TRIANGLE_STRIP,0,4,this._rectCount),this._rectCount=0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.useProgram(this._blitShader),e.drawArrays(e.TRIANGLE_STRIP,0,4)}drawRect(e,t,n,r,o,a,i){if(0===e&&0===t&&n>=320&&r>=240)this._onBackgroundChanged(o,a,i),this._bg=[o/255,a/255,i/255],this._rectCount=0,this._rectsClear=!0;else if(this._rectCount<f){const s=this._rectCount;this._rectShapes[6*s+0]=e,this._rectShapes[6*s+1]=t?t+this._fontConfig[this._fontId][3]:t,this._rectShapes[6*s+2]=n,this._rectShapes[6*s+3]=r,this._rectColours[12*s+0]=o,this._rectColours[12*s+1]=a,this._rectColours[12*s+2]=i,this._rectCount++}this._rectCount>=f&&this._renderRects(this._gl),this._queueFrame()}_textShader;_textVao;_textTex;_textColours=new Uint8Array(2880);_textChars=new Uint8Array(960);_setupText(e){if(0==this._fontId?this._textShader=g(e,"text1"):this._textShader=g(e,"text2"),e.useProgram(this._textShader),e.uniform1i(e.getUniformLocation(this._textShader,"font"),1),this._textVao=e.createVertexArray(),e.bindVertexArray(this._textVao),this._textColours.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._textColours.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._textColours,e.DYNAMIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,3,e.UNSIGNED_BYTE,!0,0,0),e.vertexAttribDivisor(0,1),this._textChars.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._textChars.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._textChars,e.DYNAMIC_DRAW),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,1,e.UNSIGNED_BYTE,!1,0,0),e.vertexAttribDivisor(1,1),this._textTex=e.createTexture(),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this._textTex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),0==this._fontId){e.texImage2D(e.TEXTURE_2D,0,e.RGBA,470,7,0,e.RGBA,e.UNSIGNED_BYTE,null);const t=new Image;t.onload=()=>{e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this._textTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,470,7,0,e.RGBA,e.UNSIGNED_BYTE,t),this._queueFrame()},t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdYAAAAHAQMAAACPwf4nAAAABlBMVEUAAAD///+l2Z/dAAABiElEQVQYGQXBwUtTcQDA8e/77dneYepTGBSocxakl9DhoUO45yiELpP8B6pBpwjFwwosf4qYF5vhpYsVZBBBYB2iYIdn5OZJEsJuMkg09LA3Efr9dHs/Px9mpdc/I4H0VZMwVQXWVn6l2thWOWdjN/9GlQYK5Zjr2LgdbvdbH8ADhrJSEC++sn4swPH3m3o4s0R3Mhcv9d262yuakmPx9VHQz9TFOnBCRUoAgD19xQ4/fot8SUvo8S4Dws0OPyeESqvdCADQpNNTGIB7mU8G0FtHu2MPBgU7739jfW2VmWjxoHjtUTCx0DXpRa+34ISqOXIDTmvSh+b7l5ZTvjgrpxaTo2jtiw+Cvtwa4e3azFwj0raZcik8ziz6evOOrVDHnfvszb+kAgFRy8cG6MI+nZAhQv5ZPQE8SwEg3M/jTxDgUwf++VhlQQBL6KceMWgZ/4lzoQ1A4g1aEq89YcJE/bXjwovCSnV9++yd2vj1cGqkfeB/qSNSMcYs1/I9h+UgNjT9t2bCrDwHUjqY5UZP3NUAAAAASUVORK5CYII="}else{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,752,9,0,e.RGBA,e.UNSIGNED_BYTE,null);const t=new Image;t.onload=()=>{e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this._textTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,752,9,0,e.RGBA,e.UNSIGNED_BYTE,t),this._queueFrame()},t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAvAAAAAJCAMAAABjeuiwAAAABlBMVEX///8AAABVwtN+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAE9WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgOS4wLWMwMDEgNzkuYzAyMDRiMmRlZiwgMjAyMy8wMi8wMi0xMjoxNDoyNCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDI0LjUgKE1hY2ludG9zaCkiIHhtcDpDcmVhdGVEYXRlPSIyMDIzLTA1LTIzVDEzOjEzOjAyLTA3OjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAyMy0wNS0yM1QxMzoyNjoyMS0wNzowMCIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAyMy0wNS0yM1QxMzoyNjoyMS0wNzowMCIgZGM6Zm9ybWF0PSJpbWFnZS9wbmciIHBob3Rvc2hvcDpDb2xvck1vZGU9IjIiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6ZTM1OGJkODItNzUyZS00MGU1LTliMTAtOTdjMjU4N2I4NzBlIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOmUzNThiZDgyLTc1MmUtNDBlNS05YjEwLTk3YzI1ODdiODcwZSIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOmUzNThiZDgyLTc1MmUtNDBlNS05YjEwLTk3YzI1ODdiODcwZSI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6ZTM1OGJkODItNzUyZS00MGU1LTliMTAtOTdjMjU4N2I4NzBlIiBzdEV2dDp3aGVuPSIyMDIzLTA1LTIzVDEzOjEzOjAyLTA3OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjQuNSAoTWFjaW50b3NoKSIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5OT74hAAADKklEQVRYhcVYR6LdIAzU5P/7X3myMBJqYPxKooVNUQNVGxAKRESEAh2KLogIIfb064mGAonke+B4gyKCOZ8A6VbnLtP8kWDYW1inQ60qZW5wqZ+u2626OR191GMxT/x270560CRcUbZVb7tgauNfdgIS0uhFeOJMgewCDA5uLiIiv1vC6zHIWE9AgYCEiIDN/lYtKE9OheiuSyHuGL0dZxcY1SzDAYeyJCgQEtcVEWFf14Nmum/aVa+gd1hi3mOVv3png91BvLeZfDB1Ch4/zPYEVvjwQ5bRv4bsD3HeODwhw4Utw4/0ne/oQjCP15Pfx2ZwiNfgKAGMOBWZtaqL2StaPWgU5vW0f6aboj7wsHtMkCj36ARnYxXzjakLzFZOzpAZXyu0LBR5w86upoSKxih03wlkcA4PpWWwDYoBe2vw3KIvVqvAoDmidg8x3/peLMdrgTf18npMnmqg5zl1B01JDYKzf5fDwT2zA9VWjCsHdN2gr3Bekd5Bu7cjZeBoa7MVjgGPtF+AlyY1w0MzPLWLsUS+8wfrDJgO7K7DoUrCmgcrg/hWnx7JF5wE3oKB01yxO4RSR/6dS3ZG6dnH4xnoNNWLqYGfj27pIDTgi1MK9SHugwGGzgEX8HZCO+F7F/CVlhSse3hYvJyd1NqF/O1adLDt3i/gcXxPb6WLMwrVpq1yNdqR3jYx/pus74verpSuHS0q5AoRxq5d4tZXp0GuTwzGOztQJDB7inFHcfotlxNaXG8zT6mcgX4bZ1rhfgvr3NJc7jW+7T5Q9L8V/k1L4xI47JEoPvVptWmfJ/TSQN73PLOEc1ZRZjs1NLdw1wOjme3xz0pLLPr3/Ot/JSEc/plj/Wn0AARCcnQ1GEFQ+0D0gjCUaG/le/6ucv2KiAAAgr8rnq43QO1aXlL26R+K0UMKhItbk9HsXGgW105Qq+p/+lXyJbGlfwlyDm31U/+eX24NjMdVZs1lcjeAlaDFj96ljyVYoaVUjTxI/RSaId05yoliu1V7swVdXC8t05oe/oEkOOsZjJDpW2n2uWjAiHcKKjXn4jVmnmf8fp7/Cm3x9y1Mey9/ARS9smac9Y/6AAAAAElFTkSuQmCC"}}_renderText(e){e.useProgram(this._textShader),e.bindVertexArray(this._textVao),this._textColours.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._textColours.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._textColours),this._textColours.updated=!1),this._textChars.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._textChars.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._textChars),this._textChars.updated=!1),e.drawArraysInstanced(e.TRIANGLE_STRIP,0,4,960)}drawText(e,t,n,r,o,a){const i=40*Math.floor(n/this._fontConfig[this._fontId][1])+Math.floor(t/this._fontConfig[this._fontId][0]);i>=960||(this._textChars[i]=e-32,this._textChars.updated=!0,this._textColours[3*i+0]=r,this._textColours[3*i+1]=o,this._textColours[3*i+2]=a,this._textColours.updated=!0,this._queueFrame())}_waveData=new Uint8Array(320);_waveColour=new Float32Array([.5,1,1]);_waveOn=!1;_setupWave(e){this._waveShader=g(e,"wave"),this._waveShader.colourUniform=e.getUniformLocation(this._waveShader,"colour"),this._waveVao=e.createVertexArray(),e.bindVertexArray(this._waveVao),this._waveData.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._waveData.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._waveData,e.STREAM_DRAW),e.enableVertexAttribArray(0),e.vertexAttribIPointer(0,1,e.UNSIGNED_BYTE,1,0)}_renderWave(e){this._waveOn&&(e.useProgram(this._waveShader),e.uniform3fv(this._waveShader.colourUniform,this._waveColour),e.bindVertexArray(this._waveVao),this._waveData.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._waveData.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._waveData),this._waveData.updated=!1),e.drawArrays(e.POINTS,0,320))}drawWave(e,t,n,r){this._waveColour[0]=e/255,this._waveColour[1]=t/255,this._waveColour[2]=n/255,0!=r.length?(this._waveData.fill(-1),this._waveData.set(r,320-r.length),this._waveData.updated=!0,this._waveOn=!0,this._queueFrame()):this._waveOn&&(this._waveOn=!1,this._queueFrame())}_renderFrame(){const e=this._gl;this._renderRects(e),this._renderText(e),this._renderWave(e),this._frameQueued=!1}_queueFrame(){this._frameQueued||(requestAnimationFrame((()=>this._renderFrame())),this._frameQueued=!0)}clear(){this._rectsClear=!0,this._rectCount=0,this._textChars.fill(0),this._textChars.updated=!0,this._waveOn=!1,this._queueFrame()}}(De,Ce):new class{_canvas;_ctx;_textNodes=[];_backgroundColour="rgb(0, 0, 0)";_frameQueued=!1;_rects=[];_waveColour="rgb(255, 255, 255)";_waveData=new Uint8Array(320);_waveOn=!1;_textUpdates={};_onBackgroundChanged;_fontConfig=[[8,10,0,0],[10,12,0,-40]];_fontId=0;constructor(e,t){this._backgroundColour=`rgb(${e[0]}, ${e[1]}, ${e[2]})`,this._onBackgroundChanged=t,this._canvas=document.getElementById("canvas"),this._ctx=canvas.getContext("2d"),this._buildText()}setFont(e){this._fontId!=e&&(this._fontId=e,this._buildText(),this.clear())}_buildText(){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg"),n=document.getElementById("canvas");for(t.setAttributeNS(null,"viewBox","0 0 640 480"),t.setAttributeNS(null,"id","screen"),t.setAttributeNS(null,"style",n.getAttribute("style")),1==this._fontId&&t.setAttributeNS(null,"class","big");t.firstChild;)t.removeChild(t.lastChild);var r=0;1==this._fontId&&(r=3);for(let n=r;n<25;n++)for(let r=0;r<39;r++){const a=document.createElementNS(e,"text"),i=r*(2*this._fontConfig[this._fontId][0]);var o=0;1==this._fontId?(o=(n-3)*(2*this._fontConfig[this._fontId][1])+2*this._fontConfig[this._fontId][1]-16,3==n&&(o+=20)):o=n*(2*this._fontConfig[this._fontId][1])+2*this._fontConfig[this._fontId][1],1==this._fontId&&(o+=10),a.setAttributeNS(null,"x",i),a.setAttributeNS(null,"y",o),a.setAttributeNS(null,"fill","_000");const s=document.createTextNode("");a.appendChild(s),t.appendChild(a),this._textNodes[39*n+r]={node:s,char:32,fill:"_000"}}document.contains(document.getElementById("screen"))&&document.getElementById("screen").remove(),this._canvas.insertAdjacentElement("afterend",t)}_renderFrame(){for(let e=0;e<this._rects.length;e++){const t=this._rects[e];this._ctx.fillStyle=t.colour,this._ctx.fillRect(t.x,t.y,t.w,t.h)}if(this._rects.length=0,this._waveUpdated&&(this._ctx.fillStyle=this._backgroundColour,this._ctx.fillRect(0,0,320,21),this._waveOn)){this._ctx.fillStyle=this._waveColour;for(let e=0;e<this._waveData.length;e++){if(255==this._waveData[e])continue;const t=Math.min(this._waveData[e],20);this._ctx.fillRect(e,t,1,1)}}this._waveUpdated=!1;for(const[e,t]of Object.entries(this._textUpdates)){const e=t.node;t.char!==e.char&&(e.node.nodeValue=String.fromCharCode(t.char),e.char=t.char),t.fill!==e.fill&&(e.node.parentElement.setAttributeNS(null,"fill",t.fill),e.fill=t.fill)}this._textUpdates={},this._frameQueued=!1}_queueFrame(){this._frameQueued||(requestAnimationFrame((()=>this._renderFrame())),this._frameQueued=!0)}drawRect(e,t,n,r,o,a,i){const s=`rgb(${o}, ${a}, ${i})`;0===e&&0===t&&n>=320&&r>=240&&(this._rects.length=0,this._backgroundColour=s,this._onBackgroundChanged(o,a,i)),1==this._fontId&&(t+=this._fontConfig[this._fontId][3]),this._rects.push({colour:s,x:e,y:t,w:n,h:r}),this._queueFrame()}drawText(e,t,n,r,o,a){const i=39*Math.floor(n/this._fontConfig[this._fontId][1])+Math.floor(t/this._fontConfig[this._fontId][0]);this._textNodes[i]&&(this._textUpdates[i]={node:this._textNodes[i],char:e,fill:`rgb(${r}, ${o}, ${a})`},this._queueFrame())}drawWave(e,t,n,r){this._waveColour=`rgb(${e}, ${t}, ${n})`,0!=r.length?(this._waveData.fill(-1),this._waveData.set(r,320-r.length),this._waveOn=!0,this._waveUpdated=!0,this._queueFrame()):this._waveOn&&(this._waveOn=!1,this._waveUpdated=!0,this._queueFrame())}clear(){this._rects=[{colour:this._backgroundColour,x:0,y:0,w:320,h:240}],this._waveOn=!1,this._waveUpdated=!0,this._textUpdates={};for(let e=0;e<this._textNodes.length;e++)this._textUpdates[e]={node:this._textNodes[e],char:32,fill:"rgb(0, 0, 0)"};this._queueFrame()}}(De,Ce),Be=new class{_state=c;_buffer=new Uint8Array(512);_i=0;_renderer;constructor(e){this._renderer=e}_processFrame(e){switch(e[0]){case 254:12===e.length?this._renderer.drawRect(e[1]+256*e[2],e[3]+256*e[4],e[5]+256*e[6],e[7]+256*e[8],e[9],e[10],e[11]):console.log("Bad RECT frame");break;case 253:12===e.length?this._renderer.drawText(e[1],e[2]+256*e[3],e[4]+256*e[5],e[6],e[7],e[8]):console.log("Bad TEXT frame");break;case 252:4===e.length?this._renderer.drawWave(e[1],e[2],e[3],u):e.length<=324?this._renderer.drawWave(e[1],e[2],e[3],e.subarray(4)):console.log("Bad WAVE frame");break;case 251:3!==e.length&&console.log("Bad JPAD frame");break;case 255:this._renderer.setFont(e[5]);break;default:console.log("BAD FRAME")}}process(e){for(let t=0;t<e.length;t++){const n=e[t];switch(this._state){case c:switch(n){case 192:this._processFrame(this._buffer.subarray(0,this._i)),this._i=0;break;case 219:this._state=l;break;default:this._buffer[this._i++]=n}break;case l:switch(n){case 220:this._buffer[this._i++]=192,this._state=c;break;case 221:this._buffer[this._i++]=219,this._state=c;break;default:this._state=d,console.log("Unexpected SLIP sequence")}break;case d:if(192===n)this._state=c,this._i=0,console.log("SLIP recovered")}}}reset(){this._state=c,this._i=0}}(Ue);let Fe=function(){const e=document.getElementById("display"),t=document.getElementById("canvas");function n(){const n=devicePixelRatio,r=e.clientWidth*n,o=document.getElementById("screen");if(R("snapPixels")&&r<=1600){let a=e.clientHeight*n;(R("showControls")||Z)&&(a/=2);const i=320*Math.floor(r/320)/n,s=240*Math.floor(a/240)/n,c=Math.round((r/n-i)/2),l=Math.round((a/n-s)/2);t.style.width=`${i}px`,t.style.height=`${s}px`,t.style.left=`${c}px`,t.style.top=`${l}px`,o&&(o.style.width=`${i}px`,o.style.height=`${s}px`,o.style.left=`${c}px`,o.style.top=`${l}px`)}else t.style.width=null,t.style.height=null,t.style.left=null,t.style.top=null,o&&(o.style.width=null,o.style.height=null,o.style.left=null,o.style.top=null)}return o(window,"resize",n),window.matchMedia("screen and (min-resolution: 2dppx)").addListener(n),n(),n}();function Ne(n){n?(t("#buttons, .error, #info"),te(10)):(Ue.clear(),e("#buttons"),re()),ge(n)}function Me(n,r){V(n),o("#connect","click",(()=>n.connect().catch((()=>{t("#info"),e(r)})))),o(window,"beforeunload",(e=>n.disconnect())),n.connect(!0).catch((()=>{}))}T("showControls",(e=>{document.getElementById("display").classList.toggle("with-controls",e),Fe()})),T("enableAudio",(e=>{e?ee||(ee=!0,te()):(ee=!1,re())})),T("midiForwarding",(e=>{e?async function(){be=await navigator.requestMIDIAccess({sysex:!0}),be.inputs.forEach((e=>{Se(e)})),be.onstatechange=e=>{Se(e.port)},Ee=!0}():Ee=!1})),T("snapPixels",(()=>Fe())),T("controlMapping",(()=>{t("#info"),(Z=!0,document.body.classList.add("mapping"),new Promise((e=>{q=e}))).then(Fe),Fe()})),T("firmware",(()=>{t("#info"),ue=null,he=null,de("file-select")})),T("fullscreen",(()=>{document.fullscreenElement?document.exitFullscreen():document.body.requestFullscreen()})),T("about",(()=>e("#info"))),navigator.serial?Me(new s(Be,Ne),"#serial-fail"):navigator.usb?Me(new i(Be,Ne),"#usb-fail"):e("#no-serial-usb"),o("#info button","click",(()=>t("#info"))),async function(){o(navigator.serviceWorker,"controllerchange",(()=>m()));let t=!navigator.serviceWorker.controller;const n=await navigator.serviceWorker.register("worker.js");o(n,"updatefound",(()=>{if(t)return void(t=!1);const r=n.installing;o(r,"statechange",(()=>{"installed"===r.state&&(w=navigator.serviceWorker.controller?()=>r.postMessage({action:"skipWaiting"}):m,e("#reload"))}))})),setInterval((()=>n.update()),18e5)}();

</script></body></html>
